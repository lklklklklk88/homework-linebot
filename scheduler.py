from line_utils import get_line_display_name
import datetime

def generate_gemini_prompt(user_id, tasks, habits, today, available_hours):
    display_name = get_line_display_name(user_id)

    now = datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=8)))
    total_minutes = now.hour * 60 + now.minute + 30
    remainder = total_minutes % 60
    rounded_minutes = total_minutes - remainder + (30 if remainder < 30 else 60)
    start_hour = rounded_minutes // 60
    start_minute = rounded_minutes % 60
    start_str = f"{int(start_hour):02d}:{start_minute:02d}"

    prompt = f"""
ä½ æ˜¯ä¸€ä½è¦ªåˆ‡åˆæœ‰æ•ˆç‡çš„ä»»å‹™åŠ©ç†ï¼Œè«‹é‡å° {display_name} åœ¨ {today} è¦åŠƒæœ€ä½³å·¥ä½œæ’ç¨‹ã€‚

ç›®å‰æ™‚é–“ç‚º {now.hour}:{now.minute:02d}ï¼Œå¯æ”¯é…æ™‚é–“ç‚º {available_hours} å°æ™‚ï¼Œè«‹å¾ {start_str} é–‹å§‹å®‰æ’ã€‚

è«‹æ ¹æ“šä»¥ä¸‹åŸå‰‡å®‰æ’ä»»å‹™ï¼š
1. å„ªå…ˆè€ƒæ…®æˆªæ­¢æ—¥æœŸ
2. æ ¹æ“šä»»å‹™é¡å‹å®‰æ’é©åˆçš„æ™‚æ®µï¼ˆä¾‹å¦‚ï¼šæ—©ä¸Šå®‰æ’éœ€è¦é«˜å°ˆæ³¨çš„ä»»å‹™ï¼‰
3. åœ¨ä»»å‹™ä¹‹é–“å®‰æ’é©ç•¶çš„ä¼‘æ¯æ™‚é–“
4. ç¸½æ™‚æ•¸ä¸è¦è¶…é 7 å°æ™‚

å›è¦†æ ¼å¼å¦‚ä¸‹ï¼š

ğŸ“ æ’ç¨‹èªªæ˜ï¼š
[ç”¨è¼•é¬†çš„èªæ°£èªªæ˜ä»Šå¤©çš„æ’ç¨‹é‡é»ï¼Œä¾‹å¦‚ï¼š
"ä»Šå¤©å¹«ä½ æ’äº† X å°æ™‚çš„ä»»å‹™ï¼Œä¸Šåˆå®‰æ’é«˜å°ˆæ³¨å…§å®¹ï¼Œä¸‹åˆæ”¾é¬†ä¸€é»"]

ğŸ’¡ æº«é¦¨æé†’ï¼š
ä»»å‹™å®Œæˆå¾Œï¼Œè¨˜å¾—åˆ°ã€å®Œæˆä½œæ¥­ã€‘é¸å–®å›å ±å–”ï¼

ğŸ“… ä»Šæ—¥æ’ç¨‹

1. ğŸ•˜ 09:00 ~ 12:30ï½œå¿«é»å®Œæˆï¼ˆ210 åˆ†é˜ï¼‰
2. ğŸ¥ª 12:30 ~ 13:00ï½œåˆé¤ï¼ˆ30 åˆ†é˜ï¼‰
3. ğŸ“– 13:00 ~ 14:00ï½œä½œæ¥­ç³»çµ±ï½œé–±è®€
4. ğŸ§  14:00 ~ 14:15ï½œä¼‘æ¯ï¼ˆ15 åˆ†é˜ï¼‰
5. ğŸ’» 14:15 ~ 15:15ï½œAI Agentï½œå¯«ç¨‹å¼
6. ğŸ§  15:15 ~ 15:30ï½œä¼‘æ¯ï¼ˆ15 åˆ†é˜ï¼‰
7. ğŸ’» 15:30 ~ 16:30ï½œAI Agentï½œå¯«ç¨‹å¼

âœ… ä»Šæ—¥ç¸½æ™‚é•·ï¼šX å°æ™‚

ä»¥ä¸‹æ˜¯ä»»å‹™è³‡æ–™ï¼ˆä¾›ä½ å®‰æ’æ™‚é–“é †åºä½¿ç”¨ï¼‰ï¼š
"""

    for i, task in enumerate(tasks, 1):
        name = task.get("task", "æœªå‘½å")
        due = task.get("due", "æœªè¨­å®š")
        est = task.get("estimated_time", "æœªæä¾›")
        category = task.get("category", "æœªåˆ†é¡")
        prompt += f"{i}. {name}ï½œD: {due}ï½œç´„ {est} å°æ™‚ï½œåˆ†é¡ï¼š{category}\n"

    return prompt

def generate_schedule_prompt(tasks, current_time, available_time):
    """
    ç”Ÿæˆæ’ç¨‹æç¤ºè©
    """
    prompt = f"""ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ’ç¨‹åŠ©æ‰‹ã€‚è«‹æ ¹æ“šä»¥ä¸‹ä»»å‹™å’Œæ™‚é–“å®‰æ’ï¼Œç”Ÿæˆä¸€å€‹åˆç†çš„ä»Šæ—¥æ’ç¨‹ã€‚

ç•¶å‰æ™‚é–“ï¼š{current_time}
å¯ç”¨æ™‚é–“ï¼š{available_time}

å¾…è¾¦ä»»å‹™ï¼š
"""
    
    # æ·»åŠ ä»»å‹™åˆ—è¡¨
    for i, task in enumerate(tasks, 1):
        prompt += f"{i}. {task['task']}ï¼ˆé è¨ˆ {task['estimated_time']} å°æ™‚ï¼Œæˆªæ­¢ï¼š{task['due']}ï¼‰\n"
    
    prompt += """
è«‹æ ¹æ“šä»¥ä¸‹åŸå‰‡å®‰æ’ä»»å‹™ï¼š
1. å„ªå…ˆå®‰æ’æˆªæ­¢æ—¥æœŸè¼ƒè¿‘çš„ä»»å‹™
2. è€ƒæ…®ä»»å‹™é¡å‹å’Œå°ˆæ³¨åº¦éœ€æ±‚
3. åœ¨é©ç•¶æ™‚é–“å®‰æ’ä¼‘æ¯
4. é¿å…éåº¦å¯†é›†çš„å®‰æ’

è«‹ç”¨ä»¥ä¸‹æ ¼å¼å›è¦†ï¼š
1. å…ˆçµ¦ä¸€å€‹è¼•é¬†çš„é–‹å ´ç™½
2. ç„¶å¾Œåˆ—å‡ºå»ºè­°çš„æ’ç¨‹ï¼ˆä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼‰ï¼š
   1. ğŸ•˜ 09:00 ~ 10:30ï½œä»»å‹™åç¨±
   2. ğŸ¥ª 12:00 ~ 13:00ï½œåˆé¤
   3. ğŸ“– 13:00 ~ 14:30ï½œä»»å‹™åç¨±
   ï¼ˆä»¥æ­¤é¡æ¨ï¼‰
3. æœ€å¾ŒåŠ ä¸Šç¸½æ™‚æ•¸æé†’

æ³¨æ„ï¼š
- ä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿä¾†è¡¨ç¤ºä¸åŒé¡å‹çš„æ´»å‹•
- æ™‚é–“æ ¼å¼ä½¿ç”¨ 24 å°æ™‚åˆ¶
- æ¯å€‹ä»»å‹™ä¹‹é–“è¦ç•™é©ç•¶çš„ä¼‘æ¯æ™‚é–“
- å¦‚æœç¸½æ™‚æ•¸è¶…é 7 å°æ™‚ï¼Œè«‹æé†’ä½¿ç”¨è€…æ³¨æ„ä¼‘æ¯
"""
    
    return prompt